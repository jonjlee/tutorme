<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Transitions - Tests</title>
    <!-- Bootstrap -->
    <link href="static/thirdparty/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/css/tutorme.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-md-8 col-md-offset-2" id="main">
                <div class="row">
                    <ol class="breadcrumb">
                        <li><a href="index.html">Capstone</a></li>
                        <li class="active"><span href="#">Practice Tests</span></li>
                    </ol>
                </div>

                <div class="row">
                    <div class="col-xs-12">
                        <h4>Tests</h4>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <p class="text-muted" id="notests">
                            Your tests will be listed here. Create a new test below.
                        </p>
                        <div class="list-group" id="existingtests">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <h4>Create a New Test</h4>
                    </div>
                </div>
                <div class="well" id="tests">
                    <div class="row">
                        <div class="col-sm-6">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-8 control-label">Number of Questions:</label>
                                    <div class="col-sm-4">
                                        <input id="numquestions" type="text" class="form-control input-sm" name="numquestions" value="46"></input>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="col-sm-6">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-8 control-label">Unused questions only</label>
                                    <div class="col-sm-4">
                                        <input id="newonly" type="checkbox" class="form-control" style="margin-top: 0px" name="newonly" checked="1"></input>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12">
                            <p>
                                <div class="list-group" id="subjects">
                                </div>
                            </p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-4">
                            <button id="selectall" class="btn btn-default">Select All</button>
                            <button id="selectnone" class="btn btn-default">Select None</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 text-center">
                            <button class="btn btn-primary" id="create">Create test</button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12" id="tests"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <script type="text/html" id="subject_tpl">
        <a href="#" class="list-group-item">
            <span class="badge">{{numQuestions}}</span>
            <span id="subject">{{subject}}</span>
        </a>
    </script>
    <script type="text/html" id="test_tpl">
        <a href="questions.html?q={{test.lastQuestion || 1}}&testid={{testId}}" class="list-group-item" id="{{id}}">
            <b>{{test.date}}</b><br/>
            <span>{{test.numquestions}} questions | {{formatTime(test.elapsedMs, true)}} elapsed</span><br/>
            <span>Subjects: {{test.subjects.join('; ')}}</span>
        </a>
    </script>
    <script type="text/html" id="test_btns_tpl">
        <div class="btn-group pull-right">
            <a id="review" class="btn btn-sm btn-default" href="questions.html?review=1&q=1&testid={{testId}}">Review</a>
            <a id="grade" type="button" class="btn btn-sm btn-default" href="testgrade.html?testid={{testId}}">Summary</a>
            <a id="delete" type="button" class="btn btn-sm btn-default">Delete</a>
        </div>
    </script>

    <!-- Scripts -->
    <script src="static/thirdparty/jquery.min.js"></script>
    <script src="static/thirdparty/jquery.hotkeys.js"></script>
    <script src="static/thirdparty/bootstrap/js/bootstrap.min.js"></script>
    <script src="static/js/util.js"></script>
    <script src="static/js/data.js"></script>
    <script type="text/javascript">
    <!--
        var storage = new Storage();

        function initUI(data) {
            $subjects = $('#subjects');
            $notests = $('#notests');            
            $existingtests = $('#existingtests');

            // Initialize list of subjects
            var subjectTpl = tmpl('subject_tpl');
            for (var i in data) {
                $subjects.append(subjectTpl({
                    numQuestions: data[i].questions.length,
                    subject: data[i].section
                }));
            }

            // Initialize list of existing test
            refreshTestList();

            // Event handlers
            $('#selectall').click(function() { $('#subjects > .list-group-item').addClass('active'); })
            $('#selectnone').click(function() { $('#subjects > .list-group-item').removeClass('active'); })
            $('#subjects > .list-group-item').click(function() { $(this).toggleClass('active'); return false; });
            $('#create').click(createTest.bind(null, data));

            // Shortcut keys
            $(document).bind('keypress', 'shift+return', function() { window.location.href = "index.html" });
        }

        function numTests(testlist) {
            return Object.keys(testlist)
                        .reduce(function(acc, key) {
                            return acc + !isNaN(key)
                        }, 0);
        }

        function refreshTestList() {
            var testlist = storage.getTestList();
                testTpl = tmpl('test_tpl'),
                testBtnsTpl = tmpl('test_btns_tpl');

            if (numTests(testlist) == 0) {
                $notests.show();
                $existingtests.hide();
            } else {
                $notests.hide();
                $existingtests.show();
                $existingtests.empty();
                for (i in testlist) (function(i) {
                    // Ignore non-numeric entries (e.g. nextId), which are not tests
                    if (isNaN(i)) { return; }
                    var id = 't' + i,
                        test = testlist[i],
                        $el = $(testTpl({
                            id: id,
                            testId: i,
                            test: test
                        }));

                    $el.prepend(testBtnsTpl({testId: i}));
                    $el.find('#delete').hover(function() {
                        $(this).addClass('btn-danger');
                    }, function() {
                        $(this).removeClass('btn-danger');
                        $(this).tooltip('hide');
                    }).dblclick(function() {
                        deleteTest(i);
                    }).click(function() { 
                        return false;
                    }).tooltip({title: 'Double click to delete (cannot be recovered)', placement: 'bottom', trigger: 'click'});

                    $existingtests.append($el);
                })(i);
            }
        }
        function createTest(data) {
            var subjects = $('.list-group-item.active > span#subject').map(function() { return $(this).text(); }).get(),
                numquestions = parseInt($('#numquestions').val());
            
            if (isNaN(numquestions) || numquestions <= 0) {
                return alert('Invalid number of questions: ' + $('#numquestions').val());
            }

            var today = new Date(),
                test = {
                    date: (today.getMonth() + 1) + '/' + today.getDate() + '/' +  today.getFullYear(),
                    numquestions: numquestions,
                    questions: getQuestions(data, subjects, numquestions),
                    subjects: subjects
                };
            if (test.numquestions > test.questions.length) {
                return alert('Could not create a test with ' + test.numquestions + ' questions.\n\n' + test.questions.length + ' remaining question(s) are available from the selected subjects.');
            }

            // Store test by ID and increment next unique ID
            var testlist = storage.getTestList();
            testlist = Array.isArray(testlist) ? {} : testlist;
            var testId = testlist.nextId || 1;
            testlist[testId] = test;
            testlist.nextId = testId+1;
            storage.saveTestList(testlist);
            refreshTestList();

            // Start test 
            window.location.href = 'questions.html?q=1&testid=' + (testId);
        }
        function deleteTest(index) {
            var testlist = storage.getTestList();
            testlist = Array.isArray(testlist) ? {} : testlist;
            delete testlist[index]
            storage.saveTestList(testlist);
            refreshTestList();
        }
        function questionId(s, q) {
            return s + ',' + q;
        }
        function getUsedQuestionIds() {
            var testlist = storage.getTestList(),
                ids = [];
            for (var i in testlist) {
                ids = ids.concat(testlist[i].questions)
            }
            return ids;
        }
        function answerable(question) {
            var questionText = question.question;
            if (!(questionText.match(/1\.\s/) && questionText.match(/2\.\s/)) && 
                (!questionText.match(/A\.\s/g) || questionText.match(/A\.\s/g).length == 1)) {
                var matches = questionText.match(/([A-M]\.(?:\s|&nbsp;)+<span>|<span>\s*[A-M]\.\s*(?:&nbsp;)+)/g);
                return matches && (matches.length >= 3);
            }
            return false;
        }
        function filterValidQuestionIds(data, ids) {
            if ($('#newonly').is(':checked')) {
                var used = getUsedQuestionIds();
                ids = ids.filter(function(id) { return used.indexOf(id) < 0; });
            }
            // Only use questions where we know the correct answer and it can be answered
            ids = ids.filter(function(id) { 
                var question = questionFromId(data, id);
                return correctAnswerFromQuestion(question) && answerable(question); 
            });
            return ids;
        }
        function questionIdsInSequence(data, seqId) {
            // Collect IDs of all questions with the given sequence ID
            // in order across all sections.
            var ids = []
            $.each(data, function(s, section) {
                $.each(section.questions, function(q, question) {
                    if (question.sequence === seqId) {
                        ids.push(questionId(s, q));
                    }
                });
            });
            return ids;
        }
        function collectSequences(data, ids, limit) {
            var i = 0;

            // Sequences are questions that need to be presented in a specific order.
            // Only check for sequence questions in the first <limit> ids
            while (i < Math.min(limit, ids.length)) {
                var question = questionFromId(data, ids[i]);
                if (question.sequence) {
                    // Get IDs for every question in the sequence in order
                    var seqIds = questionIdsInSequence(data, question.sequence)

                    // Swap out seqIds.length questions from the current position with
                    // the questions in this sequence
                    for (var j = 0; j < seqIds.length; j++) {
                        var idx = ids.indexOf(seqIds[j]);
                        if (idx >= 0) {
                            var temp = ids[i];
                            ids[i] = ids[idx];
                            ids[idx] = temp;
                        } else {
                            ids[i] = seqIds[j];
                        }
                        i++;
                    }
                }
                i++;
            }
            return ids;
        }
        function getQuestions(data, sections, num) {
            var ids = [];
            for (var i in data) {
                var section = data[i];
                if (sections.indexOf(section.section) >= 0) {
                    var numquestions = section.questions.length;
                    for (var j = 0; j < numquestions; j++) {
                        ids.push(questionId(i,j));
                    }
                }
            }
            ids = filterValidQuestionIds(data, ids)
            shuffleArray(ids);
            ids = collectSequences(data, ids, num);
            return ids.splice(0, num);
        }
        
        // Set up keyboard shortcuts and button actions
        initUI(data);
    -->
    </script>
    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-48235520-1', 'jonjlee.github.io');
      ga('send', 'pageview');
    </script>
</body>
</html>