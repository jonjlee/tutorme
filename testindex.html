<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Transitions - Tests</title>
    <!-- Bootstrap -->
    <link href="static/thirdparty/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/css/tutorme.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-md-8 col-md-offset-2" id="main">
                <div class="row">
                    <ol class="breadcrumb">
                        <li><a href="index.html">Capstone</a></li>
                        <li class="active"><span href="#">Practice Tests</span></li>
                    </ol>
                </div>

                <div class="row">
                    <div class="col-xs-12">
                        <h4>Tests</h4>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <p class="text-muted" id="notests">
                            Your tests will be listed here. Create new tests below.
                        </p>
                        <div class="list-group" id="existingtests">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <h4>Create a New Test</h4>
                    </div>
                </div>
                <div class="well" id="tests">
                    <div class="row">
                        <div class="col-sm-6">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-8 control-label">Number of Questions:</label>
                                    <div class="col-sm-4">
                                        <input id="numquestions" type="text" class="form-control input-sm" name="numquestions" value="46"></input>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="col-sm-6">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-8 control-label">Unused questions only</label>
                                    <div class="col-sm-4">
                                        <input id="newonly" type="checkbox" class="form-control" style="margin-top: 0px" name="newonly" checked="1"></input>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12">
                            <p>
                                <div class="list-group" id="subjects">
                                </div>
                            </p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-4">
                            <button id="selectall" class="btn btn-default">Select All</button>
                            <button id="selectnone" class="btn btn-default">Select None</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 text-center">
                            <button class="btn btn-primary" id="create">Create test</button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12" id="tests"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="static/thirdparty/jquery.min.js"></script>
    <script src="static/thirdparty/bootstrap/js/bootstrap.min.js"></script>
    <script src="static/js/data.js"></script>
    <script type="text/javascript">
    <!--
        var testlistStorageKey = 'tutorme.capstone.testlist';
        var testbtns = '<div class="btn-group pull-right">' + 
                        '<button id="open" type="button" class="btn btn-sm btn-default">Open</button>'+
                        '<button id="grade" type="button" class="btn btn-sm btn-default">Grade</button>'+
                        '<button id="delete" type="button" class="btn btn-sm btn-default">Delete</button>'+
                        '</div>';

        function initUI() {
            $subjects = $('#subjects');
            for (var i in data) {
                var a = $('<a href="#" class="list-group-item"></a>');
                a.append($('<span class="badge">'+data[i].questions.length+'</span>'));
                a.append($('<span id="subject">'+data[i].section+'<span>'));
                $subjects.append(a);
            }

            $notests = $('#notests');            
            $existingtests = $('#existingtests');
            refreshTestList();

            $('#selectall').click(function() { $('#subjects > .list-group-item').addClass('active'); })
            $('#selectnone').click(function() { $('#subjects > .list-group-item').removeClass('active'); })
            $('#subjects > .list-group-item').click(function() { $(this).toggleClass('active'); return false; });
            $('#create').click(createTest);
        }

        function refreshTestList() {
            var testlist = JSON.parse(localStorage.getItem(testlistStorageKey) || '[]')
            if (testlist.length == 0) {
                $notests.show();
                $existingtests.hide();
            } else {
                $notests.hide();
                $existingtests.show();
                $existingtests.empty();
                for (i in testlist) {
                    var t = testlist[i],
                        id = 't' + i,
                        el = $('<a href="#" class="list-group-item" id="'+id+'"/>');

                    el.append($(testbtns))
                        .append($('<b>'+t.date+'</b><br/>'))
                        .append($('<span>'+t.numquestions+' questions</span><br/>'))
                        .append($('<span>Subjects: '+t.subjects.join('; ')+'</span>'));
                    $existingtests.append(el);

                    $('#' + id + ' #delete').hover(function() {
                        $(this).addClass('btn-danger');
                    }, function() {
                        $(this).removeClass('btn-danger');
                        $(this).tooltip('hide');
                    }).dblclick(function() {
                        deleteTest(i);
                    }).click(function() { 
                        return false;
                    }).tooltip({title: 'Double click to delete', placement: 'bottom', trigger: 'click'});
                }
            }
        }
        function createTest() {
            var subjects = $('.list-group-item.active > span#subject').map(function() { return $(this).text(); }).get(),
                numquestions = parseInt($('#numquestions').val());
            
            if (isNaN(numquestions)) {
                return alert('Invalid number of questions: ' + $('#numquestions').val());
            }

            var today = new Date(),
                test = {
                    date: (today.getMonth() + 1) + '/' + today.getDate() + '/' +  today.getFullYear(),
                    numquestions: numquestions,
                    questions: getQuestions(subjects, numquestions),
                    subjects: subjects
                };
            if (test.numquestions > test.questions.length) {
                return alert('Could not create a test with ' + test.numquestions + ' questions.\n\n' + test.questions.length + ' remaining question(s) are available from the selected subjects.');
            }

            var testlist = JSON.parse(localStorage.getItem(testlistStorageKey) || '[]')
            testlist.push(test);
            localStorage.setItem(testlistStorageKey, JSON.stringify(testlist));
            refreshTestList();
        }
        function deleteTest(index) {
            var testlist = JSON.parse(localStorage.getItem(testlistStorageKey) || '[]')
            testlist.splice(index, 1)
            if (testlist.length == 0) {
                localStorage.removeItem(testlistStorageKey);
            } else {
                localStorage.setItem(testlistStorageKey, JSON.stringify(testlist));
            }
            refreshTestList();
        }
        function questionId(s, q) {
            return s + ',' + q;
        }
        function questionFromId(data, id) {
            parts = id.split(',');
            return data[parseInt(parts[0])].questions[parseInt(parts[1])]
        }
        function getUsedQuestionIds() {
            var testlist = JSON.parse(localStorage.getItem(testlistStorageKey) || '[]'),
                ids = [];
            for (var i in testlist) {
                ids = ids.concat(testlist[i].questions)
            }
            return ids;
        }
        function filterValidQuestionIds(ids) {
            if ($('#newonly').is(':checked')) {
                var used = getUsedQuestionIds();
                return ids.filter(function(id) { return used.indexOf(id) < 0; });
            }
            return ids;
        }
        function getQuestions(sections, num) {
            var ids = [];
            for (var i in data) {
                var section = data[i];
                if (sections.indexOf(section.section) >= 0) {
                    var numquestions = section.questions.length;
                    for (var j = 0; j < numquestions; j++) {
                        ids.push(i + ',' + j);
                    }
                }
            }
            ids = filterValidQuestionIds(ids)
            shuffleArray(ids);
            return ids.splice(0, num);
        }
        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
            return array;
        }
        
        // Set up keyboard shortcuts and button actions
        initUI();
    -->
    </script>
</body>
</html>