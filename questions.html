<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Transitions</title>
    <!-- Bootstrap -->
    <link href="static/thirdparty/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="static/thirdparty/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="static/thirdparty/jquery-notebook/jquery.notebook.min.css" />
    <link rel="stylesheet" href="static/thirdparty/fancybox/jquery.fancybox.css" type="text/css" media="screen" />
    <link href="static/css/tutorme.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <div class="modal fade" id="search-dlg" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="config-dlg" tabindex="-1" role="dialog" aria-labelledby="config-dlg-title" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <h4>Options:</h4>
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" id="show-notes-option">
                            Show notes
                        </label>
                    </div>
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" id="dark-color-scheme-option"></input>
                            Dark color scheme
                        </label>
                    </div>
                    <h4>Shortcuts keys:</h4>
                    <dl class="dl-horizontal">
                        <dt>Left / right arrow</dt>
                        <dd>Previous / next question</dd>
                        <dt>Shift + left / right</dt>
                        <dd>Previous / next section</dd>
                        <dt>Shift + enter</dt>
                        <dd>Back to dashboard</dd>
                        <dt>s</dt>
                        <dd>Show / hide answer</dd>
                        <dt>n</dt>
                        <dd>Show or hide the Notes box.</dd>
                        <dt>1 - 5</dt>
                        <dd>Select mastery level</dd>
                        <dt>0</dt>
                        <dd>Clear mastery selection</dd>
                        <dt>Control + d</dt>
                        <dd>Toggle dark color scheme</dd>
                    </dl>
                </div>
                <div class="modal-footer">
                    <div class="pull-left">Concerns or suggestions? Take a moment to <a href="mailto:jonathan-lee@ouhsc.edu?subject=Capstone tutorials issue">email me.</a></div>
                    <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Done</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-md-8 col-md-offset-2" id="main">
                <div class="row">
                    <ol class="breadcrumb">
                        <li><a href="index.html">Capstone</a></li>
                        <li class="active"><span id="section" href="#"></span></li>
                        <button class="btn btn-sm btn-default hidden-xs pull-right" data-toggle="modal" data-target="#config-dlg">
                            <span class="glyphicon glyphicon-cog" id="config"></span>
                        </button>
                        <div class="hidden-xs col-xs-3 pull-right">
                            <input type="text" class="form-control input-xs" placeholder="Search..." id="search">
                        </div>
                    </ol>
                </div>

                <div class="row">
                    <div class="col-sm-8">
                        <div class="row">
                            <h3> 
                                <span class="prev"><i class="arrow small glyphicon glyphicon-chevron-left"></i></span>
                                Question <span id="qnum"></span>
                                <span class="next"><i class="arrow small glyphicon glyphicon-chevron-right"></i></span>
                            </h3>
                        </div>
                    </div>
                    <div class="col-sm-4 hidden" style="padding-top: 7px;">
                        <span>
                            <h3><small>Elapsed Time: <span id="timer"></span></small></h3>
                        </span>
                    </div>
                    <div class="col-sm-4" id="mastery">
                        Mastery:
                        <span class="btn-group">
                            <button id="mastery-1" type="button" class="btn btn-default">1</button>
                            <button id="mastery-2" type="button" class="btn btn-default">2</button>
                            <button id="mastery-3" type="button" class="btn btn-default">3</button>
                            <button id="mastery-4" type="button" class="btn btn-default">4</button>
                            <button id="mastery-5" type="button" class="btn btn-default">5</button>
                        </span>
                    </div>
                </div>
                <div class="row">&nbsp;</div>

                <div class="row" id="question-panel">
                    <div class="col-xs-12">
                        <div class="row" id="qtext"></div>
                    </div>
                </div>
                <div class="row">&nbsp;</div>
                
                <div class="row">
                    <button class="btn btn-primary" id="show">Show Answer</button>
                    <a class="btn btn-primary pull-right" style="display:none;" href="" id="submit">End Test</a>
                </div>
                
                <div class="row" style="display:none" id="answer">
                    <hr/>
                    <div class="row">
                        <div class="col-xs-12 text-center" id="show-notes"><small><a class="btn btn-link">Show Notes</a></small></div>
                        <div class="col-xs-12 text-center text-muted" id="source"></div>
                        <div class="col-md-12" id="answer-text"></div>
                        <div class="col-md-3 hidden-sm hidden-xs" id="notes-panel" style="display:none;">
                            <div class="affix-notes" id="notes" style="display:none;">
                                <div class="row panel panel-default">
                                    <div class="panel-heading" style="padding: 3px 10px">
                                        Notes
                                        <button class="btn btn-link btn-xs pull-right" id="hide-notes">Hide</button>
                                    </div>
                                    <div id="notes-editor"></div>
                                </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12">
                            <ul class="pager">
                                <li><a class="prev" href="#"><i class="arrow small glyphicon glyphicon-chevron-left"></i> Previous</a></li>
                                <li><a class="next" href="#">Next <i class="arrow small glyphicon glyphicon-chevron-right"></i></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="static/thirdparty/jquery.min.js"></script>
    <script src="static/thirdparty/jquery.hotkeys.js"></script>
    <script src="static/thirdparty/jquery.textHighlighter.pack.min.js"></script>
    <script src="static/thirdparty/bootstrap/js/bootstrap.min.js"></script>
    <script src="static/thirdparty/jquery-notebook/jquery.notebook.min.js"></script>
    <script type="text/javascript" src="static/thirdparty/fancybox/jquery.fancybox.pack.js"></script>
    <script src="static/js/data.js"></script>
    <script src="static/js/util.js"></script>
    <script type="text/javascript">
    <!--
        // elapsedTimeout is a global var to ensure there is only ever one timer on the page.
        var elapsedTimeout = null;

        // -----------------------------------------------------------------
        // Main UI functionality: question, choices, tutorial, and config
        // -----------------------------------------------------------------
        var UI = function(data, qparams) {
            this.$breadcrumb = $('.breadcrumb');
            this.$qtext = $('#qtext');
            this.$answer = $('#answer');
            this.$answerText = $('#answer-text');
            this.$source = $('#source');
            this.$search = $('#search');
            this.$searchResults = $('#search-dlg');
            this.$config = $('#config-dlg');

            var testId = parseInt(qparams.testid),
                sectionNum = parseInt(qparams.section),
                questionNum = parseInt(qparams.q),
                getQKey = this.getQKey.bind(this);

            sectionNum = isNaN(sectionNum) ? 0 : Math.max(sectionNum-1);
            questionNum = isNaN(questionNum) ? 0 : Math.max(0, questionNum-1);

            // Initialize common UI components
            this.data = data;
            this.storage = new Storage(this.getQKey.bind(this));
            this.testMode = !isNaN(testId),
            this.reviewMode = !!qparams.review,
            this.colorScheme = new ColorScheme('body', '#main', '#dark-color-scheme-option', this.storage);
            this.notes = new Notes('#notes-panel', '#notes', '#notes-editor', '#show-notes-option', '#show-notes', '#hide-notes', '#answer-text', this.storage);
            this.navigation = new Navigation('.prev', '.next', '#show', '#answer', '#qnum', sectionNum, questionNum, data.length, this);
            this.search = new Search(data, '#search', '#search-dlg');

            if (this.testMode) {
                // UI components for practice test mode
                $('#mastery').hide();
                $('#show').hide();
                this.testing = new Testing(data, testId, this.reviewMode, '#timer', '#submit', this.storage);
            } else {
                // Mastery feature is only available in tutorial mode
                this.mastery = new Mastery('#mastery', '#mastery-', this.storage);
            }
            if (!this.testMode || this.reviewMode) {
                // Highlights are available in tutorial and review modes
                this.highlights = new Highlights('#qtext', '#answer-text', this.storage);
            }

            // Shortcut keys
            $(document).bind('keypress', 'a', this.selectOption.bind(this, 0));
            $(document).bind('keypress', 'b', this.selectOption.bind(this, 1));
            $(document).bind('keypress', 'c', this.selectOption.bind(this, 2));
            $(document).bind('keypress', 'd', this.selectOption.bind(this, 3));
            $(document).bind('keypress', 'e', this.selectOption.bind(this, 4));
            $(document).bind('keypress', 'f', this.selectOption.bind(this, 5));
            $(document).bind('keypress', 'g', this.selectOption.bind(this, 6));
        };
        UI.prototype.getQKey = function() {
            return (this.testing) ?
                this.testing.getQuestionId(this.navigation.questionNum) :
                this.navigation.sectionNum + ',' + this.navigation.questionNum;
        },
        UI.prototype.numQuestions = function() {
            return (this.testing) ?
                this.testing.numQuestions :
                this.data[this.navigation.sectionNum].questions.length;
        };
        UI.prototype.selectOption = function(opt) {
            $($('input[type=radio]')[opt]).prop('checked', true);
            if (this.testing) {
                this.testing.selectOption(this.navigation.questionNum, opt+1);
            }
        };
        UI.prototype.initBreadcrumb = function(paths) {
            this.$breadcrumb.find('li').remove();
            this.$breadcrumb.append('<li><a href="index.html">Capstone</a></li>');
            for (var i in paths) {
                var path = paths[i];
                if (typeof(path) === 'string') {
                    this.$breadcrumb.append('<li class="active"><span href="#">'+path+'</span></li>');
                } else {
                    this.$breadcrumb.append('<li><a href="'+path.href+'">'+path.text+'</a></li>');
                }
            }
        };
        UI.prototype.initQuestionText = function(questionText) {
            // Add radio button before each choice if we can. Don't add radio
            // button for matching questions (those with choices A-Z. and 1-9.) or multiple part questions
            // (those with more than one A. answer), which mess up the A-Z shortcut keys.
            if (!(questionText.match(/1\.\s/) && questionText.match(/2\.\s/)) && 
                    (!questionText.match(/A\.\s/g) || questionText.match(/A\.\s/g).length == 1)) {
                questionText = questionText.replace(/([A-M]\.(?:\s|&nbsp;)+<span>|<span>\s*[A-M]\.\s*(?:&nbsp;)+)/g, '<input type="radio" name="opt"></input> &nbsp;&nbsp; $1');
            }
            this.$qtext.html(questionText);
        };
        UI.prototype.initMedia = function() {
            $.fancybox.close(true);
            $('.fancybox').fancybox();
        };
        UI.prototype.showQuestion = function(sectionNum, questionNum) {
            sectionNum = sectionNum || this.navigation.sectionNum;
            questionNum = questionNum || this.navigation.questionNum;

            // Get testing / tutorial specific question and answer data
            var section, question, breadcrumb, numQuestions, selectedAnswer, correct, source;
            if (this.testing) {
                var testQId = this.testing.getQuestionId(questionNum),
                    id_parts = testQId.split(',');
                    
                sectionNum = parseInt(id_parts[0]);
                var actualQuestionNum = parseInt(id_parts[1]);

                section = this.data[sectionNum];
                question = section.questions[actualQuestionNum];

                breadcrumb = [{href: 'testindex.html', text: 'Practice Tests'}, 'Test - Created ' + this.testing.test.date ];
                numQuestions = this.testing.numQuestions;
                
                selectedAnswer = this.testing.getUserAnswer(actualQuestionNum);
                correct = this.reviewMode && correctAnswerFromQuestion(question)
                source = '<p><small><a href="questions.html?&review=1&section=' + (sectionNum+1) + '&q=' + (actualQuestionNum+1) + '">' + section.section + ' #' + (actualQuestionNum+1) + '</a></small></p>';

                // Store the last visited question for the practice test
                this.testing.setLastQuestion(actualQuestionNum);
            } else {
                section = this.data[sectionNum];
                question = section.questions[questionNum];

                breadcrumb = [section.section];
                numQuestions = this.data[sectionNum].questions.length;
                
                selectedAnswer = null;
                correct = null;
                source = null;
            }

            // Breadcrumb text
            this.initBreadcrumb(breadcrumb);
            
            // Update mastery selector
            if (this.mastery) { this.mastery.read(); }

            // Show/hide prev/next question arrows
            this.navigation.initQuestionNumber(questionNum, numQuestions);

            // Question text and choices
            this.initQuestionText(question.question);

            // Select user's answer and correct answer
            if (selectedAnswer) { this.selectOption(selectedAnswer-1); }
            if (correct) { this.testing.selectCorrect(selectedAnswer, correct); }

            // Fill in answer with source and always start with it hidden, unless in review mode
            this.$answerText.html(question.answer);
            if (source) { this.$source.html(source); }
            if (this.reviewMode) {
                this.$answer.show();
            } else {
                this.$answer.hide();
            }

            // Restore highlights
            if (this.highlights) { this.highlights.read(); }

            // Enable pop up media
            this.initMedia();

            // Restore notes
            this.notes.restore();

            // Update URL
            if (window.history) {
                var urlVars = getUrlVars();
                if (urlVars.q != '' + (questionNum+1)) {
                    window.history.pushState('', '', '?' + 
                        'q=' + (questionNum+1) +
                        (this.testMode ? '' : '&section='+(sectionNum+1)) + 
                        (this.testMode ? '&testid='+this.testing.testId : '') + 
                        (this.reviewMode ? '&review=1' : ''));
                    // Also post page view to google analytics
                    if (typeof ga !== 'undefined') { ga('send', 'pageview', window.location.pathname + window.location.search); }
                    PUSHED_STATE = true;
                }
            }
        };

        // ------------------------------------------------
        // Switch between light and dark color schemes
        // ------------------------------------------------
        var ColorScheme = function(body, main, opt, storage) {
            this.$body = $(body);
            this.$main = $(main);
            this.$opt = $(opt);
            this.storage = storage;
            this.isDark = false;

            // Shortcut key
            $(document).bind('keypress', 'ctrl+d', this.toggle.bind(this));

            // Event handler for dark color scheme option
            this.$opt.change(this.handleOptChange.bind(this));

            // Initialize colorscheme
            var color = this.storage.getColor();
            if (color == 'dark') {
                this.dark();
                this.$opt.prop('checked', true);
            }
        }
        ColorScheme.DARK_BKG = 'rgb(50, 50, 50)';
        ColorScheme.DARK_COLOR = 'rgb(230, 230, 230)';
        ColorScheme.LIGHT_BKG = 'url(../img/bkg3.jpg) no-repeat center center fixed'
        ColorScheme.LIGHT_COLOR = 'white'
        ColorScheme.prototype.toggle = function() {
            return this.isDark && this.normal() || this.dark();
        };
        ColorScheme.prototype.normal = function() {
            this.$body.css('background', 'url(../img/bkg3.jpg) no-repeat center center fixed');
            this.$main.css('background-color', 'white');
            this.$opt.prop('checked', false);
            this.isDark = false;
            STORAGE.clearColor();
        };
        ColorScheme.prototype.dark = function () {
            this.$body.css('background', 'rgb(50, 50, 50)');
            this.$main.css('background-color', 'rgb(230, 230, 230)');
            this.$opt.prop('checked', true);
            this.isDark = true;
            STORAGE.saveColor('dark');
        };
        ColorScheme.prototype.handleOptChange = function() {
            return (this.$opt.is(':checked')) && this.dark() || this.normal();
        };

        // ------------------------------------------------
        // Practice test mode
        // ------------------------------------------------
        var Testing = function(data, testId, reviewMode, timer, submit, storage) {
            this.$timer = $(timer);
            this.$timerContainer = this.$timer.closest('div');
            this.$submit = $(submit);
            this.testId = testId;
            this.storage = storage;
            this.test = this.getTest();
            this.numQuestions = this.test && this.test.questions.length || 0;
            this.startupElapsedMs = this.test && this.test.elapsedMs || 0;

            if (!reviewMode) {
                // Activate timer unless in review mode
                this.$timerContainer.removeClass('hidden');
                this.refreshTimer(); 

                // Show End Test button and set button target
                this.$submit.show();
                this.$submit.attr('href', 'testgrade.html?testid=' + testId);
            }

        };
        Testing.prototype.getQuestionId = function(questionNum) {
            if (!this.test || questionNum >= this.test.questions.length ) { return null; }
            return this.test.questions[questionNum];
        };
        Testing.prototype.setLastQuestion = function(questionNum) {
            var test = this.getTest();
            test.lastQuestion = questionNum+1;
            this.saveTest(test);
        };
        Testing.prototype.getTest = function() {
            var testlist = this.storage.getTestList();
            return testlist[this.testId]
        };
        Testing.prototype.saveTest = function(test) {
            var testlist = this.storage.getTestList();
            testlist[this.testId] = test;
            this.storage.saveTestList(testlist);
        };
        Testing.prototype.getUserAnswer = function(questionNum) {
            return (this.test.answers && this.test.answers[questionNum] || null);
        };
        Testing.prototype.selectCorrect = function(user, correct) {
            var opts = $('input[type=radio]');
            if (correct && correct <= opts.length) {
                $('<span><i class="fa fa-check text-success"/>&nbsp;&nbsp;</span> ').insertBefore(opts[correct-1]);
                $(opts[correct-1]).prev().css('margin-left', '-20px')
            }
            if (user && user != correct) {
                $('<span><i class="fa fa-ban text-danger"/>&nbsp;&nbsp;</span> ').insertBefore(opts[user-1]);
                $(opts[user-1]).prev().css('margin-left', '-20px')
            }
        };
        Testing.prototype.selectOption = function(questionNum, opt) {
            var test = this.getTest();
            if (!test) { return; }

            test.answers = test.answers || [];
            test.answers[questionNum] = opt;
            this.saveTest(test);
        }
        Testing.prototype.refreshTimer = function() {
            // Stop any previous timer
            clearTimeout(elapsedTimeout);

            // Update timer as (elapsed time at page load + time since load)
            var elapsedSinceStartup = new Date() - STARTUP_TIME,
                elapsedMs = (this.startupElapsedMs || 0) + elapsedSinceStartup,
                elapsedMin = elapsedMs / 1000 / 60,
                h = Math.floor(elapsedMin / 60),
                mm = Math.floor(elapsedMin) % 60,
                ss = Math.floor(elapsedMs / 1000) % 60;

            mm = (mm<10 ? '0' : '') + mm;
            ss = (ss<10 ? '0' : '') + ss;
            this.$timer.text(h + ':' + mm + ':' + ss);
            elapsedTimeout = setTimeout(this.refreshTimer.bind(this), 1000);

            // Store elapsed time
            var test = this.getTest();
            test.elapsedMs = elapsedMs;
            this.saveTest(test);
        };

        // ------------------------------------------------
        // Manage the user's mastery recall
        // ------------------------------------------------
        var Mastery = function(container, buttonPrefix, storage) {
            this.$container = $(container);
            this.buttonPrefix = buttonPrefix;
            this.storage = storage;

            // Shortcut key
            $(document).bind('keypress', '0', this.select.bind(this, -1));
            $(document).bind('keypress', '1', this.select.bind(this, 1));
            $(document).bind('keypress', '2', this.select.bind(this, 2));
            $(document).bind('keypress', '3', this.select.bind(this, 3));
            $(document).bind('keypress', '4', this.select.bind(this, 4));
            $(document).bind('keypress', '5', this.select.bind(this, 5));

            // Button click handlers
            $(buttonPrefix + '1').click(function() { selectMastery(1); });
            $(buttonPrefix + '2').click(function() { selectMastery(2); });
            $(buttonPrefix + '3').click(function() { selectMastery(3); });
            $(buttonPrefix + '4').click(function() { selectMastery(4); });
            $(buttonPrefix + '5').click(function() { selectMastery(5); });
        };
        Mastery.prototype.clear = function() {
            this.storage.clearMastery();
            this.select(0);
        };
        Mastery.prototype.read = function() {
            this.select(this.storage.getCurrentMastery() || 0);
        };
        Mastery.prototype.select = function(n) {
            this.$container.find('button').removeClass('active btn-info');
            if (n > 0) {
                this.$container.find(this.buttonPrefix + n).addClass('active btn-info');
            }

            if (n <= 0) {
                this.storage.clearCurrentMastery();
            } else {
                this.storage.saveCurrentMastery(n);
            }
        };

        // ------------------------------------------------
        // Manage user notes in the answer section
        // ------------------------------------------------
        var Notes = function(panel, affixedContainer, editor, opt, showLink, hideLink, answerText, storage) {
            var $answerText = $(answerText);
            this.$panel = $(panel);
            this.$affixedContainer = $(affixedContainer);
            this.$editor = $(editor);
            this.$opt = $(opt);
            this.$showLink = $(showLink);
            this.$hideLink = $(hideLink);
            this.$answerText = $answerText;
            this.storage = storage;

            // Initialize notes box
            if (this.storage.getNotes('visible')) { this.show(); }
            this.$editor.notebook({ placeholder: '', modifiers: ['bold', 'italic', 'underline', 'ol', 'ul'] });
            this.$editor.on('input', this.save.bind(this));
            this.$editor.keydown(this.handleKeydown.bind(this));
            this.$affixedContainer.affix({offset: { top: function() { return $answerText.offset().top - 10; }}});

            // Hide / show link and config option handlers
            this.$showLink.click(this.show.bind(this));
            this.$hideLink.click(this.hide.bind(this));
            this.$opt.change(this.handleOptChange.bind(this));
        };
        Notes.prototype.toggle = function() {
            return this.$opt.is(':checked') && hideNotes() || showNotes();
        };
        Notes.prototype.show = function() {
            this.$answerText.removeClass('col-md-12').addClass('col-md-9');
            this.$showLink.hide();
            this.$panel.show();
            this.$affixedContainer.show();
            this.updateOpt(true);
        };
        Notes.prototype.hide = function() {
            $answerText.removeClass('col-md-9').addClass('col-md-12');
            this.$showLink.show();
            this.$panel.hide();
            this.$affixedContainer.hide();
            this.updateOpt(false);
        };
        Notes.prototype.save = function() {
            var notes = this.$editor.html();
            if (this.storage.getCurrentNotes() != notes) {
                this.storage.saveCurrentNotes($.trim(notes));
            }
        };
        Notes.prototype.restore = function() {
            var notes = this.storage.getCurrentNotes() || '';
            this.$editor.html(notes);
        };
        Notes.prototype.updateOpt = function(visible) {
            var notes = this.storage.getNotes();
            notes['visible'] = visible;
            this.storage.saveNotes(notes);
            this.$opt.prop('checked', visible);
        };
        Notes.prototype.handleKeydown = function(e) {
            if (e.keyCode == 27) { this.$editor.blur(); }
        };
        Notes.prototype.handleOptChange = function() {
            return this.$opt.is(':checked') && showNotes() || hideNotes();
        };
        Notes.prototype.refreshWidth = function() {
            this.$affixedContainer.width(this.$affixedContainer.parent().width());
        };

        // ------------------------------------------------
        // Manage user's highlighting
        // ------------------------------------------------
        var Highlights = function(qtext, answerText, storage) {
            var $qtext = $(qtext),
                $answerText = $(answerText),
                save = this.deferSave.bind(this);

            this.$qtext = $qtext;
            this.$answerText = $answerText;
            this.storage = storage;

            // Initialize text highlighter plugin and remove highlights on click
            this.$qtext.textHighlighter({ onAfterHighlight: save, onRemoveHighlight: save });
            this.$qtext.on('click', '.highlighted', function() { $qtext.getHighlighter().removeHighlights(this); });
            this.$answerText.textHighlighter({ onAfterHighlight: save, onRemoveHighlight: save });
            this.$answerText.on('click', '.highlighted', function() { $qtext.getHighlighter().removeHighlights(this); });
        };
        Highlights.prototype.deferSave = function(highlights, range) {
            // Wait for current call stack to clear before calling saveHighlights(). This allows for
            // highlights to be applied / removed by the JQuery TextHighlighter plugin after it triggers
            // the respective event.
            setTimeout(this.save.bind(this, highlights, range), 1);
            return true;
        };
        Highlights.prototype.save = function(highlights, range) {
            // Serialize currently highlighted text
            var qhilites = this.$qtext.getHighlighter().serializeHighlights();
            var ahilites = this.$answerText.getHighlighter().serializeHighlights();
            
            // Determine if anything has been updated, and store new highlights
            var qupdated = (this.storage.getCurrentHilites('q') != qhilites);
            var aupdated = (this.storage.getCurrentHilites('a') != ahilites);

            // Save highlights
            if (qupdated) { this.storage.saveCurrentHilites('q', qhilites); }
            if (aupdated) { this.storage.saveCurrentHilites('a', ahilites); }
        };
        Highlights.prototype.read = function() {
            var qhilites = this.storage.getCurrentHilites('q');
            var ahilites = this.storage.getCurrentHilites('a');
            if (qhilites) { this.$qtext.getHighlighter().deserializeHighlights(qhilites); }
            if (ahilites) { this.$answerText.getHighlighter().deserializeHighlights(ahilites); }
        }

        // ----------------------------------------------------------------------
        // Navigate between questions, sections, hiding/showing answer, etc
        // ----------------------------------------------------------------------
        var Navigation = function(prev, next, showAnswer, answer, qnum, sectionNum, questionNum, numSections, ui) {
            this.$prev = $(prev);
            this.$next = $(next);
            this.$showAnswer = $(showAnswer);
            this.$answer = $(answer);
            this.$qnum = $(qnum);
            this.sectionNum = sectionNum;
            this.questionNum = questionNum;
            this.numSections = numSections;
            this.ui = ui;

            // Shortcut keys
            $(document).bind('keydown', 'left', this.prevQuestion.bind(this));
            $(document).bind('keydown', 'right', this.nextQuestion.bind(this));
            $(document).bind('keypress', 'return', this.nextQuestion.bind(this));
            $(document).bind('keypress', 'shift+return', this.gotoDashboard.bind(this));

            // Event handlers
            this.$prev.click(this.prevQuestion.bind(this));
            this.$next.click(this.nextQuestion.bind(this));

            if (!this.ui.testMode) {
                // Shortcut keys and event handlers specific for tutorial mode
                $(document).bind('keypress', 's', this.toggleAnswer.bind(this));
                $(document).bind('keydown', 'shift+left', this.prevSection.bind(this));
                $(document).bind('keydown', 'shift+right', this.nextSection.bind(this));

                this.$showAnswer.click(this.toggleAnswer.bind(this));
            }
        };
        Navigation.prototype.gotoDashboard = function() {
            window.location.href = this.ui.testMode && "testindex.html" || "index.html";
        }
        Navigation.prototype.initQuestionNumber = function(qnum, numqs) {
            // Show/hide prev/next question arrows
            if (qnum == 0) {
                this.$prev.hide();
                this.$next.show();
            } else if (qnum < numqs-1) {
                this.$prev.show();
                this.$next.show();
            } else {
                this.$prev.show();
                this.$next.hide();
            }

            // "Question x of y" and actual question text
            this.$qnum.text(qnum+1 + ' of ' + numqs)
        };
        Navigation.prototype.nextQuestion = function() {
            if (this.questionNum < this.ui.numQuestions()-1 ) {
                this.ui.showQuestion(this.sectionNum, ++this.questionNum);
            }
        }
        Navigation.prototype.prevQuestion = function() {
            if (this.questionNum > 0) {
                this.ui.showQuestion(this.sectionNum, --this.questionNum);
            }
        };
        Navigation.prototype.nextSection = function() {
            if (this.sectionNum < this.numSections-1) {
                this.questionNum = 0;
                this.ui.showQuestion(++this.sectionNum, this.questionNum);
            }
        };
        Navigation.prototype.prevSection = function() {
            if (this.sectionNum > 0) {
                this.questionNum = 0;
                this.ui.showQuestion(--this.sectionNum, this.questionNum);
            }
        };
        Navigation.prototype.toggleAnswer = function() {
            this.$answer.toggle();
            if (this.$answer.is(':visible')) {
                $('html,body').animate({scrollTop: this.$answer.offset().top - 250}, 'fast');
                
                // Update notes editor
                this.ui.notes.refreshWidth();
            }
        };

        // -----------------------------------------------------------------
        // Find and display questions
        // -----------------------------------------------------------------
        var Search = function(data, input, dialog) {
            this.data = data;
            this.$input = $(input);
            this.$dialog = $(dialog);

            this.$input.bind('keypress', 'return', this.execute.bind(this));
        };
        Search.prototype.execute = function() {
            var text = this.$input.val();
            var p = new RegExp(text, 'i');
            var matches = [];
            $.each(this.data, function(i, section) {
                $.each(section.questions, function(j, details) {
                    if (p.test(details.question) || p.test(details.answer)) {
                        matches.push({sectionNum: i+1, section: section.section, questionNum: j+1, question: details.question});
                    }
                })
            });

            if (matches) {
                var contents = $.map(matches, function(m) {
                    var text = $.trim($('<p>' + m.question + '</p>').text());
                    return '<dt><a href="questions.html?section=' + m.sectionNum + '&q=' + m.questionNum + '">' + m.section + ' #' + (m.questionNum) + '</a></dt>' +
                        '<dd>' + $.trim(text.substring(0, 200)) + '...</dd><br/>';
                });
                this.$dialog.find('.modal-body').html('<dl>' + contents.join('\n') + '</dl>');
                this.$dialog.modal();
            }
        };

        function load() {
            ui = new UI(data, getUrlVars());
            ui.showQuestion();
        }

        // Load when document ready and when going back/forward with popstate
        $(document).ready(load);
        window.onpopstate = function() { return isOnLoadPopState() || load(); }
    -->
    </script>
    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-48235520-1', 'jonjlee.github.io');
      ga('send', 'pageview');
    </script>
</body>
</html>